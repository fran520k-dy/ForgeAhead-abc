name: æ™¨æ›´ä½œä¸šcf wop

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 3 * * 1"  # æ¯å‘¨ä¸€å‡Œæ™¨3ç‚¹ UTC æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´å‘¨ä¸€ä¸Šåˆ11ç‚¹ï¼‰
  workflow_dispatch:
    inputs:
      force_update:
        description: 'æ˜¯å¦å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥ç‰ˆæœ¬æ£€æŸ¥ï¼‰'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: "latest"

      - name: å®‰è£…ä¾èµ–
        run: |
          npm install -g javascript-obfuscator
          sudo apt-get update
          sudo apt-get install -y jq curl unzip wget

      - name: ç¯å¢ƒå˜é‡è®¾ç½®
        run: |
          echo "REPO_URL=https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases" >> $GITHUB_ENV
          echo "TARGET_FILE=worker.js" >> $GITHUB_ENV  # è°ƒæ•´ä¸º worker.js ä»¥åŒ¹é…æ··æ·†é€»è¾‘ï¼›å¦‚æœéœ€è¦ zipï¼Œå¯ä¿®æ”¹ä¸º worker.zip å¹¶æ·»åŠ è§£å‹åæ··æ·†

      - name: æ£€æŸ¥ä¸æ›´æ–° Worker
        id: update_worker
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          log() { echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"; }

          log "â˜€ï¸ æ¸…æ™¨å¯ç¨‹ï¼Œæ£€æŸ¥æ›´æ–°ä¸­â€¦"

          LOCAL_VERSION=$(cat version.txt 2>/dev/null || echo "")
          log "æœ¬åœ°ç‰ˆæœ¬ï¼š${LOCAL_VERSION:-æ— }"

          log "è¯·æ±‚æœ€æ–° Release ä¿¡æ¯â€¦"
          RESPONSE=$(curl -s --retry 5 --retry-delay 2 --max-time 30 \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "$REPO_URL")
          if [ $? -ne 0 ]; then
            log "âŒ æ— æ³•è®¿é—® GitHub API"
            exit 1
          fi

          TAG_NAME=$(echo "$RESPONSE" | jq -r '.[0].tag_name')
          DOWNLOAD_URL=$(echo "$RESPONSE" | jq -r '.[0].assets[] | select(.name == "'"$TARGET_FILE"'") | .browser_download_url')

          if [ -z "$TAG_NAME" ] || [ "$TAG_NAME" = "null" ]; then
            log "âŒ è·å–ç‰ˆæœ¬å·å¤±è´¥"
            exit 1
          fi

          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
            # å¤‡ç”¨ä¸‹è½½æ–¹å¼ï¼šä» repo ä¸‹è½½æ–‡ä»¶ï¼ˆå‡è®¾æ–‡ä»¶åœ¨ repo æ ¹ç›®å½•ï¼‰
            DOWNLOAD_URL="https://github.com/bia-pain-bache/BPB-Worker-Panel/raw/${TAG_NAME}/${TARGET_FILE}"
            log "âš ï¸ æœªæ‰¾åˆ° Release èµ„äº§ï¼Œä½¿ç”¨ raw æ–‡ä»¶ä¸‹è½½ URL: $DOWNLOAD_URL"
          fi

          log "æœ€æ–°ç‰ˆæœ¬ï¼š$TAG_NAME"

          FORCE_UPDATE="${{ github.event.inputs.force_update || 'false' }}"
          if [ "$LOCAL_VERSION" = "$TAG_NAME" ] && [ "$FORCE_UPDATE" != "true" ]; then
            log "âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
            exit 0
          fi

          log "â¬‡ï¸ ä¸‹è½½ $TARGET_FILEâ€¦"
          wget -q --tries=5 --timeout=30 -O "origin.js" "$DOWNLOAD_URL"
          if [ $? -ne 0 ]; then
            log "âŒ ä¸‹è½½å¤±è´¥"
            exit 1
          fi

          # å¦‚æœæ˜¯ zipï¼Œæ·»åŠ è§£å‹ï¼ˆå½“å‰å‡è®¾ jsï¼›å¦‚æœ zipï¼Œå–æ¶ˆæ³¨é‡Šå¹¶è°ƒæ•´ï¼‰
          # log "ğŸ“¦ è§£å‹ä¸­â€¦"
          # unzip -o "origin.js" > /dev/null  # å®é™…ä¸º zip æ—¶æ”¹å
          # rm "origin.js"
          # mv worker.js origin.js  # å‡è®¾ zip å†…æœ‰ worker.js

          log "ğŸ”’ æ··æ·† JS ä»£ç â€¦"
          javascript-obfuscator origin.js --output _worker.js \
            --compact true \
            --identifier-names-generator hexadecimal \
            --rename-globals false \
            --string-array false \
            --transform-object-keys false \
            --self-defending false \
            --simplify true
          echo "// Auto obfuscated at $(date -u)" >> _worker.js
          rm origin.js

          echo "$TAG_NAME" > version.txt
          log "âœ¨ æ›´æ–°å®Œæˆï¼Œå½“å‰ç‰ˆæœ¬ï¼š$TAG_NAME"

          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: æäº¤åŒæ­¥ç»“æœ
        if: success()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ è‡ªåŠ¨åŒæ­¥ Worker ç‰ˆæœ¬: ${{ steps.update_worker.outputs.tag_name }}"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
